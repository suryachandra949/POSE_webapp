<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Power Optimised Software Envelope Models</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
          /* ===============================
           Base
           =============================== */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #EEEBE5;
        }
      
        /* ===============================
           Controls
           =============================== */
        .controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            position: relative;   /* REQUIRED */
            z-index: 10;          /* ABOVE Plotly */
        }
      
        /* DO NOT TOUCH z-index ON SELECT */
        select {
            min-width: 260px;
            padding: 4px 6px;
            font-size: 14px;
        }
      
        /* ===============================
           Plotly ‚Äî push DOWN instead
           =============================== */
        .js-plotly-plot {
            position: relative;
            z-index: 1;   /* ‚Üê THIS IS THE KEY */
        }

      
        /* ===============================
           Layout
           =============================== */
        #main {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            margin-top: 16px;
        }
      
        .block {
            display: flex;
            gap: 12px;
            width: 100%;
            max-width: 1100px;
        }
      
        .plot{
          flex: 1;
          min-height: 360px;
          height: 45vh;
          max-height: 520px;
          min-width: 0;

          /* IMPORTANT: don't style this like a card */
          background: transparent;
          border: none;
          border-radius: 0;
          padding: 0;
        }


        @media (max-width: 900px) {
            .block {
                flex-direction: column;
            }

            .results {
                width: 100%;
            }
        }

      
        /* ===============================
           Results panel
           =============================== */
        .results {
            width: 260px;
            padding: 12px;
            border: 1px solid #999;
            background: #F8F6F0;
            font-size: 14px;
            border-radius: 4px;
        }
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-body {
            position: relative;
        }
                /* ===============================
           Metrics tables styling
           =============================== */
        .metrics-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .metrics-table th,
        .metrics-table td {
            border: 1px solid #bbb;   /* ‚Üê grid lines */
            padding: 6px 8px;
            text-align: left;
            vertical-align: top;
        }

        .metrics-table thead th {
            background: #eee;
            font-weight: bold;
        }

        .metrics-table tbody tr:nth-child(even) {
            background: #f9f9f9;
        }

        /* Optional: derived table emphasis */
        .derived-table th {
            background: #e8f0ff;
        }

        /* Container for the options */
        .options {
            display: flex;
            gap: 20px;
            margin-top: 50px;
        }

        /* Each circle */
        .option {
            width: 50px;
            height: 50px;
            border: 2px solid #555;
            border-radius: 50%;       /* makes it a circle */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s;
            user-select: none;
        }

        /* Highlight selected circle */
        .option.selected {
            background-color: #4caf50;
            border-color: #4caf50;
            color: white;
        }

        /* Hover effect */
        .option:hover {
            border-color: #2196f3;
        }
        /* ===== Header ===== */
        .app-header {
          background: #6b4a3f;
          color: white;
          padding: 24px 32px;
        }

        .app-header h1 {
          margin: 0 0 6px;
          font-size: 28px;
        }

        .app-header p {
          margin: 0;
          opacity: 0.9;
          max-width: 900px;
        }

        /* ===== Filters Card ===== */
        .filters-card {
          background: #F8F6F0;
          border-bottom: 2px solid #d6cfc4;
          padding: 16px 24px 20px;
        }

        .filters-title {
          display: flex;
          align-items: center;
          gap: 10px;
          font-weight: 600;
          margin-bottom: 16px;
        }

        /* ===== Grid layout ===== */
        .filters-grid {
          display: grid;
          grid-template-columns: repeat(4, minmax(220px, 1fr));
          gap: 16px 24px;
        }

        .filter-item label {
          display: block;
          font-size: 13px;
          margin-bottom: 6px;
        }

        .filter-item input,
        .filter-item select {
          width: 100%;
          padding: 6px 8px;
          font-size: 14px;
        }

        /* Button cell */
        .button-item {
          display: flex;
          align-items: flex-end;
        }

        .button-item button {
          width: 100%;
          padding: 8px;
          font-weight: 600;
        }

        /* ===== Options row ===== */
        .options-row {
          display: flex;
          gap: 16px;
          margin-top: 20px;
        }

        /* ===== Responsive ===== */
        @media (max-width: 1100px) {
          .filters-grid {
            grid-template-columns: repeat(2, 1fr);
          }
        }

        @media (max-width: 600px) {
          .filters-grid {
            grid-template-columns: 1fr;
          }
        }

        .filters-title {
            cursor: pointer;
            user-select: none;
        }

        .toggle-icon {
          font-size: 18px;
          transition: transform 0.25s ease;
        }

        /* collapsed state */
        .filters-card.collapsed .filters-content {
          display: none;
        }

        .filters-card.collapsed .toggle-icon {
          transform: rotate(-90deg);
        }

        .plot-area {
          flex: 1;
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .plot-controls{
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 12.5px;

          flex-wrap: wrap;                 /* responsive */
          padding-bottom: 8px;
          border-bottom: 1px solid #d6cfc4; /* divider like reference UI */
        }

        .plot-controls label{
          margin-right: 4px;
          font-weight: 600;
          white-space: nowrap;
        }

        .plot-controls select{
          min-width: 130px;   /* wider = looks embedded */
          padding: 4px 6px;
          font-size: 13px;
        }

        .plot-card{
          background: #F8F6F0;
          border: 1.5px solid #999;
          border-radius: 6px;
          padding: 10px;
        }

        .clear-plot-btn{
          margin-left: auto;          /* push to right */
          width: 28px;
          height: 28px;
                
          display: flex;
          align-items: center;
          justify-content: center;
                
          font-size: 16px;
          line-height: 1;
                
          border: none;
          background: transparent;
          border-radius: 4px;
                
          cursor: pointer;
          color: #555;
        }
        
        .clear-plot-btn:hover{
          background: #e6e6e6;
          color: #000;
        }
        
        .clear-plot-btn:active{
          background: #dcdcdc;
        }


    </style>

</head>
<body>

<div class="app-header">
  <div class="header-left">
    <h1>Power Optimised Software Envelope Models</h1>
    <p>
      Interactive analysis of runtime‚Äìenergy tradeoffs using POSE models.
    </p>
  </div>
</div>

<div class="filters-card">
  <div class="filters-title" id="filtersToggle">
  <span class="toggle-icon" id="toggleIcon">‚öôÔ∏è</span>
  <span>Filters</span>
  </div>

  <div class="filters-content" id="filtersContent">
  <div class="filters-grid">

    <!-- Dataset -->
    <div class="filter-item">
      <label>Dataset</label>
      <select id="datasetSelect">
        <option value="MG">MG</option>
        <option value="FFT">FFT</option>
        <option value="LU">LU</option>
        <option value="CG">CG</option>
        <option value="BT">BT</option>
        <option value="EP">EP</option>
        <option value="SP">SP</option>
        <option value="HACC">HACC</option>
      </select>
    </div>



    <!-- Alpha -->
    <div class="filter-item">
      <label>Œ± (alpha)</label>
      <input id="alpha" type="number" step="any"
        value="0.00000004444444444" />
    </div>

    <!-- Beta -->
    <div class="filter-item">
      <label>Œ≤ (beta)</label>
      <input id="beta" type="number" step="any"
        value="0.00006363423285" />
    </div>


    </div>

  </div>

  <!-- Options row -->
  <div class="options-row">
    <div class="option" data-value="EDD">EDD</div>
    <div class="option" data-value="EDS">EDS</div>
    <div class="option" data-value="EDP">EDP</div>
  </div>
</div>



<div id="main">

    <!-- ===== CASE 1 ===== -->
    <div class="block">
        <div class="plot-area">
          <div class="plot-card">
          <div class="plot-controls">
            <label>PLOT:</label>
            <select id="pointSelect1"></select>
          
            <label>COMPUTE:</label>
            <select id="computeSelect1"></select>

            <button
              class="clear-plot-btn"
              data-plot="plot1"
              type="button"
              title="Clear plot"
              aria-label="Clear plot">
              üßπ

            </button>

          </div>

          <div id="plot1" class="plot"></div>
        </div>
        </div>


        <div id="results1" class="results">
            <h3>POSE MODEL</h3>

            <div class="tabs">
                <button class="tab-btn active" data-tab="points1">Point Metrics</button>
                <button class="tab-btn" data-tab="derived1">Insights</button>
            </div>
            <div class="tab-body">
                <div class="tab-content active" id="tab-points1">
                  <div id="results-content1"></div>
                </div>

                <div class="tab-content" id="tab-derived1">
                  <div id="derived-content1"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== CASE 2 ===== -->
    <div class="block">
        <div class="plot-area">
          <div class="plot-card">
          <div class="plot-controls">
            <label>PLOT:</label>
            <select id="pointSelect2"></select>
          
            <label>COMPUTE:</label>
            <select id="computeSelect2"></select>
            <button
              class="clear-plot-btn"
              data-plot="plot2"
              type="button"
              title="Clear plot"
              aria-label="Clear plot">
              üßπ

            </button>
          </div>

          <div id="plot2" class="plot"></div>
        </div>
        </div>

        <div id="results2" class="results">
            <h3>CACHE-AWARE POSE MODEL</h3>

            <div class="tabs">
                <button class="tab-btn active" data-tab="points2">Point Metrics</button>
                <button class="tab-btn" data-tab="derived2">Insights</button>
            </div>
            <div class="tab-body">
            <div class="tab-content active" id="tab-points2">
                <div id="results-content2"></div>
            </div>

            <div class="tab-content" id="tab-derived2">
                <div id="derived-content2"></div>
            </div>
            </div>
        </div>
    </div>

    <!-- ===== CASE 3 ===== -->
    <div class="block">
        <div class="plot-area">
          <div class="plot-card">
          <div class="plot-controls">
            <label>PLOT:</label>
            <select id="pointSelect3"></select>
          
            <label>COMPUTE:</label>
            <select id="computeSelect3"></select>
            <button
              class="clear-plot-btn"
              data-plot="plot3"
              type="button"
              title="Clear plot"
              aria-label="Clear plot">
              üßπ

            </button>
          </div>

          <div id="plot3" class="plot"></div>
        </div>
        </div>

        <div id="results3" class="results">
            <h3>Frequency and powercap analysis space(Brainstorming space)</h3>

            <div class="tabs">
                <button class="tab-btn active" data-tab="points3">Point Metrics</button>
                <button class="tab-btn" data-tab="derived3">Insights</button>
            </div>
            <div class="tab-body">
            <div class="tab-content active" id="tab-points3">
                <div id="results-content3"></div>
            </div>

            <div class="tab-content" id="tab-derived3">
                <div id="derived-content3"></div>
            </div>
            </div>
        </div>
    </div>

</div>



<script>
    // -------------------------------
    // Data from Flask
    // -------------------------------
//    const allPoints = {{ points | safe }};
//    const power = {{ power | safe }};

    let allPoints = {{ points | tojson }};
    let powerSets = {{ power_sets | tojson }};

    const datasetSelect = document.getElementById("datasetSelect");

    const plotUI = {
      plot1: {
        pointSelect: document.getElementById("pointSelect1"),
        computeSelect: document.getElementById("computeSelect1")
      },
      plot2: {
        pointSelect: document.getElementById("pointSelect2"),
        computeSelect: document.getElementById("computeSelect2")
      },
      plot3: {
        pointSelect: document.getElementById("pointSelect3"),
        computeSelect: document.getElementById("computeSelect3")
      }
    };



    // -------------------------------
    // State tracking
    // -------------------------------
    const addedLabels = new Set();

    const plottedPoints = new Map(); // label -> point

    let plotContexts = [
      {
        plotId: "plot1",
        power: powerSets.case1,
        pmin: Math.min(...Object.values(powerSets.case1)),
        pmax: Math.max(...Object.values(powerSets.case1)),
        resultsId: "results-content1",
        derivedId: "derived-content1"
      },
      {
        plotId: "plot2",
        power: powerSets.case2,
        pmin: Math.min(...Object.values(powerSets.case2)),
        pmax: Math.max(...Object.values(powerSets.case2)),
        resultsId: "results-content2",
        derivedId: "derived-content2"
      },
      {
        plotId: "plot3",
        power: powerSets.case3,
        pmin: Math.min(...Object.values(powerSets.case3)),
        pmax: Math.max(...Object.values(powerSets.case3)),
        resultsId: "results-content3",
        derivedId: "derived-content3"
      }
    ];

    let selectedOption = null;  // store the currently selected circle
    

    // -------------------------------
    // Helpers
    // -------------------------------

    function resizeAllPlots() {
      ["plot1", "plot2", "plot3"].forEach(id => {
        const el = document.getElementById(id);
        if (el) Plotly.Plots.resize(el);
      });
    }

    window.addEventListener("resize", resizeAllPlots);


    function recomputeXMax(plotId) {
        const gd = document.getElementById(plotId);
        const xVals = gd.data.flatMap(t => t.x || []);
        return Math.max(...xVals, 1);
    }


    function updatePowerLines(plotId, xMax) {
      const gd = document.getElementById(plotId);
    
      gd.data.forEach((trace, i) => {
        if (trace.meta?.type === "power") {
          const slope = trace.meta.slope;
        
          Plotly.restyle(
            plotId,
            {
              x: [[0, xMax]],
              y: [[0, slope * xMax]]
            },
            [i]
          );
        }
      });
    }



//    function removeIntersectionTraces() {
//        const gd = document.getElementById("plot");
//        const indices = [];
//
//        gd.data.forEach((trace, i) => {
//            if (trace.meta && trace.meta.type === "intersection") {
//                indices.push(i);
//            }
//        });
//
//        if (indices.length > 0) {
//            Plotly.deleteTraces("plot", indices);
//        }
//
//        intersectionKeys.clear();
//    }
//
    function removeComputeTraces(plotId) {
        const gd = document.getElementById(plotId);
        const idx = [];
    
        gd.data.forEach((t, i) => {
            if (t.meta && (
                t.meta.type === "intersection" ||
                t.meta.type === "edd" ||
                t.meta.type === "edd_limit" ||
                t.meta.type === "D_line" ||
                t.meta.type === "C_line"
            )) {
                idx.push(i);
            }
        });
      
        if (idx.length) {
            Plotly.deleteTraces(plotId, idx);
        }
    }


    function labelPositionFromLine(line) {
        if (line === "pmax") return "top center";
        if (line === "pmin") return "bottom center";
        return "top right"; // fallback
    }

   
    function updateResultsPanel(containerId,metrics) {
        const rows = metrics.point_metrics;
    
        const tbody = rows.map(row => `
            <tr>
                <td>${row.label}</td>
                <td>${row.runtime.toFixed(5)}</td>
                <td>${row.energy.toFixed(5)}</td>
            </tr>
        `).join("");
          
        document.getElementById(containerId).innerHTML = `
            <table class="metrics-table">
                <thead>
                    <tr>
                        <th>Label</th>
                        <th>Runtime(s)</th>
                        <th>Energy(J)</th>
                    </tr>
                </thead>
                <tbody>
                    ${tbody}
                </tbody>
            </table>
        `;
    }

    function updateDerivedMetrics(containerId,derived) {
        const rows = derived.map(row => `
            <tr>
                <td>${row.name}</td>
                <td>${fmt(row.Absolute,row.value_unit)} ${row.value_unit}</td>
                <td>${Number(row.Relative).toFixed(3)}</td>
            </tr>
        `).join("");
          
        document.getElementById(containerId).innerHTML = `
            <table class="metrics-table derived-table">
                <thead>
                    <tr>
                        <th>Insight</th>
                        <th>Absolute</th>
                        <th>Relative</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows}
                </tbody>
            </table>
        `;
    }

    function fmt(v, value_unit, digits = 3) {
        if (value_unit === "%" ){
          return v.toFixed(7);
        }

        else{
          return (typeof v === "number" && isFinite(v))
              ? v.toFixed(digits)
              : "‚Äî";
        }
    }

    function runComputeForPlot(plotId, label, optionValue) {
  if (!label || !optionValue) return;

  const alpha = Number(document.getElementById("alpha").value);
  if (!isFinite(alpha) || alpha <= 0) { alert("Œ± must be a positive number"); return; }

  const beta = Number(document.getElementById("beta").value);
  if (!isFinite(beta) || beta <= 0) { alert("Œ≤ must be a positive number"); return; }

  const ctx = plotContexts.find(c => c.plotId === plotId);
  if (!ctx) return;

  removeComputeTraces(plotId);

  // ‚úÖ plot3 special behavior: COMPUTE: ALL plotted points
  if (plotId === "plot3") {
    if (plottedPoints.size === 0) return;
    plottedPoints.forEach((p) => {
      fetch("/compute", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          point: p,
          pmin: ctx.pmin,
          pmax: ctx.pmax,
          alpha,
          beta,
          option: optionValue
        })
      })
      .then(r => r.json())
      .then(data => {
        Plotly.addTraces(plotId, {
          x: data.D_line.runtime,
          y: data.D_line.energy,
          mode: "lines",
          name: "max energy save",
          line: { color: "black", width: 2, dash: "dashdot" },
          meta: { type: "D_line" }
        });

        Plotly.addTraces(plotId, {
          x: data.C_line.runtime,
          y: data.C_line.energy,
          mode: "lines",
          name: "Contribution Bound",
          line: { color: "blue", width: 2 },
          meta: { type: "C_line" }
        });

        updatePowerLines(plotId, recomputeXMax(plotId));
      });
    });
    return;
  }

  // ‚úÖ plot1/plot2 normal behavior: COMPUTE: selected label
  const p = plottedPoints.get(label);
  if (!p) return;

  fetch("/compute", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      point: p,
      pmin: ctx.pmin,
      pmax: ctx.pmax,
      alpha,
      beta,
      option: optionValue
    })
  })
  .then(r => r.json())
  .then(data => {
    data.intersections.forEach(pt => {
      Plotly.addTraces(plotId, {
        x: [pt.x],
        y: [pt.y],
        mode: "markers+text",
        marker: { size: 9, symbol: "circle", color: "black" },
        text: [pt.label],
        textposition: labelPositionFromLine(pt.line),
        textfont: { size: 12, color: "black" },
        showlegend: false,
        meta: { type: "intersection" }
      });
    });

    Plotly.addTraces(plotId, {
      x: data.edd_curve_limit.runtime,
      y: data.edd_curve_limit.energy,
      mode: "lines",
      name: "EDD limit constraint",
      line: { color: "orange", width: 2, dash: "dashdot" },
      meta: { type: "edd_limit" }
    });

    Plotly.addTraces(plotId, {
      x: data.edd_curve.runtime,
      y: data.edd_curve.energy,
      mode: "lines",
      name: "EDD optimisation constraint",
      line: { color: "orange", width: 2 },
      meta: { type: "edd" }
    });

    Plotly.addTraces(plotId, {
      x: data.D_line.runtime,
      y: data.D_line.energy,
      mode: "lines",
      name: "max energy save",
      line: { color: "black", width: 2, dash: "dashdot" },
      meta: { type: "D_line" }
    });

    Plotly.addTraces(plotId, {
      x: data.C_line.runtime,
      y: data.C_line.energy,
      mode: "lines",
      name: "Contribution Bound",
      line: { color: "blue", width: 2 },
      meta: { type: "C_line" }
    });

    updatePowerLines(plotId, recomputeXMax(plotId));
    updateResultsPanel(ctx.resultsId, data.metrics);
    updateDerivedMetrics(ctx.derivedId, data.metrics.derived_metrics);
  });
}

function attachComputeSelectHandlers() {
  Object.entries(plotUI).forEach(([plotId, ui]) => {
    ui.computeSelect.onchange = () => {
      const label = ui.computeSelect.value;
      if (!label || !selectedOption) return;
      runComputeForPlot(plotId, label, selectedOption);
    };
  });
}




    document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => {

        // find the parent results panel
        const results = btn.closest(".results");

        // deactivate tabs ONLY in this panel
        results.querySelectorAll(".tab-btn").forEach(b =>
            b.classList.remove("active")
        );
        results.querySelectorAll(".tab-content").forEach(c =>
            c.classList.remove("active")
        );

        // activate selected
        btn.classList.add("active");
        results
            .querySelector("#tab-" + btn.dataset.tab)
            .classList.add("active");
        });
    });

// ========================
// Initialize dataset
// ========================
function loadDataset(name){
    fetch(`/load_dataset/${name}`)
      .then(res=>{
          if(!res.ok) throw new Error("HTTP "+res.status);
          return res.json();
      })
      .then(data=>{
          allPoints = data.points;
          powerSets = data.power_sets;

          resetPointDropdown(allPoints);
          resetAllPlots();
          initPlots();
          attachAddPointHandlers();
          attachComputeSelectHandlers();

      })
      .catch(err=>{
          console.error("Failed to load dataset:", name, err);
          alert("Failed to load dataset: "+name);
      });
}

datasetSelect.addEventListener("change", ()=>loadDataset(datasetSelect.value));

document.addEventListener("DOMContentLoaded", () => {
    resetPointDropdown(allPoints);
    resetAllPlots();
    initPlots();
    attachAddPointHandlers();
    attachComputeSelectHandlers();
    attachClearButtons();

    // Set default alpha and beta values
    document.getElementById("alpha").value = "0.00000004444444444";
    document.getElementById("beta").value = "0.00006363423285";

    const defaultOption = options[0];          // choose first circle by default
    defaultOption.classList.add("selected");   // highlight
    selectedOption = defaultOption.dataset.value;

    const filtersToggle = document.getElementById("filtersToggle");
    const filtersCard = document.querySelector(".filters-card");
    const toggleIcon = document.getElementById("toggleIcon");

    filtersToggle.addEventListener("click", () => {
        const collapsed = filtersCard.classList.toggle("collapsed");

        // Change icon
        toggleIcon.textContent = collapsed ? "‚ò∞" : "‚öôÔ∏è";

        // Resize plots after toggle
        setTimeout(() => {
          ["plot1", "plot2", "plot3"].forEach(id => {
            const el = document.getElementById(id);
            if (el) Plotly.Plots.resize(el);
          });
  }, 150);
});

});

function initPlots(){
    plotContexts = [
      {
        plotId: "plot1",
        power: powerSets.case1,
        pmin: Math.min(...Object.values(powerSets.case1)),
        pmax: Math.max(...Object.values(powerSets.case1)),
        resultsId: "results-content1",
        derivedId: "derived-content1"
      },
      {
        plotId: "plot2",
        power: powerSets.case2,
        pmin: Math.min(...Object.values(powerSets.case2)),
        pmax: Math.max(...Object.values(powerSets.case2)),
        resultsId: "results-content2",
        derivedId: "derived-content2"
      },
      {
        plotId: "plot3",
        power: powerSets.case3,
        pmin: Math.min(...Object.values(powerSets.case3)),
        pmax: Math.max(...Object.values(powerSets.case3)),
        resultsId: "results-content3",
        derivedId: "derived-content3"
      }
    ];


    plotContexts.forEach(ctx=>{
        const COLORS = ["green","red"];

        const entries = Object.entries(ctx.power).sort((a, b) => a[1] - b[1]); 
        const powerTraces = entries.map(
          ([name,slope],i)=>({
            x:[0,1],
            y:[0,slope],
            mode:"lines",
            name:name,
            line:{color: COLORS[i]||"gray", width:2},
            meta:{type:"power", slope:slope, name:name}
          })
        );
        Plotly.newPlot(
            ctx.plotId,
            powerTraces,
            {
              autosize: true,
              paper_bgcolor: "#F8F6F0",   // outside plot area
              plot_bgcolor: "#fafafa",  // inside plot area
            
              xaxis: {
                title: "Runtime",
                showgrid: true,
                gridcolor: "#ddd",
                zeroline: false,
                showline: true,
                linewidth: 2,
                linecolor: "#000",
                mirror: true           // border on all sides
              },
            
              yaxis: {
                title: "Energy",
                showgrid: true,
                gridcolor: "#ddd",
                zeroline: false,
                showline: true,
                linewidth: 2,
                linecolor: "#000",
                mirror: true
              },
            
              margin: { l: 60, r: 30, t: 40, b: 50 },
              legend: {
                bgcolor: "rgba(255,255,255,0.9)",
                bordercolor: "#aaa",
                borderwidth: 1
              }
            },
            {
                responsive: true
            }
        );
    });
}


function resetPointDropdown(points) {
  // reset plot dropdowns
  Object.values(plotUI).forEach(ui => {
    ui.pointSelect.innerHTML = `<option value="">-- select --</option>`;
    points.forEach((p, i) => ui.pointSelect.appendChild(new Option(p.label, i)));

    ui.computeSelect.innerHTML = `<option value="">-- plotted points --</option>`;
  });

  addedLabels.clear();
  plottedPoints.clear();
}

function attachAddPointHandlers() {
  Object.entries(plotUI).forEach(([plotId, ui]) => {
    ui.pointSelect.onchange = () => {
      const idx = ui.pointSelect.value;
      if (idx === "") return;

      const p = allPoints[idx];
      if (!p) return;

      // track globally (so plot3 can loop all points)
      if (!addedLabels.has(p.label)) {
        addedLabels.add(p.label);
        plottedPoints.set(p.label, p);
      }

      // PLOT: to THIS plot only
      Plotly.addTraces(plotId, {
        x: [p.runtime],
        y: [p.energy],
        mode: "markers",
        name: p.label,
        
        marker: { size: 8 }
      });

      updatePowerLines(plotId, recomputeXMax(plotId));

      // add to THIS plot‚Äôs compute dropdown
      const exists = Array.from(ui.computeSelect.options).some(o => o.value === p.label);
      if (!exists) ui.computeSelect.appendChild(new Option(p.label, p.label));

      // optionally auto-select last added point for compute
      ui.computeSelect.value = p.label;

      ui.pointSelect.value = "";
    };
  });
}



function resetAllPlots() {
    ["plot1", "plot2", "plot3"].forEach(id => {
        Plotly.purge(id);
    });
}

// Circle click handler
const options = document.querySelectorAll(".option");
options.forEach(opt => {
  opt.addEventListener("click", () => {
    options.forEach(o => o.classList.remove("selected"));
    opt.classList.add("selected");

    selectedOption = opt.dataset.value;

    // recompute plots that have a selected compute point
    Object.entries(plotUI).forEach(([plotId, ui]) => {
      const label = ui.computeSelect.value;
      if (!label) return;
      runComputeForPlot(plotId, label, selectedOption);
    });
  });
});


// Add change listeners to alpha and beta inputs
["alpha", "beta"].forEach(id => {
  const input = document.getElementById(id);
  
  input.addEventListener("change", () => {
    const value = Number(input.value);
    
    if (!isFinite(value) || value <= 0) {
      alert(`${id} must be a positive number`);
      // Optionally reset to default if invalid
      input.value = (id === "alpha") 
        ? "0.00000004444444444" 
        : "0.00006363423285";
      return;
    }

    // If needed, you can trigger a recompute here automatically
    Object.entries(plotUI).forEach(([plotId, ui]) => {
      const label = ui.computeSelect.value;
      if (label && selectedOption) runComputeForPlot(plotId, label, selectedOption);
    });

    console.log(`${id} changed to`, value);
    
  });
});

function getPowerTraceIndices(plotId){
  const gd = document.getElementById(plotId);
  if (!gd || !gd.data) return [];
  const keep = [];
  gd.data.forEach((t, i) => {
    if (t.meta?.type === "power") keep.push(i);
  });
  return keep;
}

function clearPlot(plotId){
  const ctx = plotContexts.find(c => c.plotId === plotId);
  if (!ctx) return;

  const gd = document.getElementById(plotId);
  if (!gd || !gd.data) return;

  // delete everything except power lines
  const keep = new Set(getPowerTraceIndices(plotId));
  const toDelete = gd.data.map((_, i) => i).filter(i => !keep.has(i));
  if (toDelete.length) Plotly.deleteTraces(plotId, toDelete);

  // also remove compute traces (safe if already removed)
  removeComputeTraces(plotId);

  // reset power line extents back to baseline
  updatePowerLines(plotId, 1);

  // reset this plot's dropdowns
  if (plotUI[plotId]) {
    plotUI[plotId].computeSelect.innerHTML = `<option value="">-- plotted points --</option>`;
    plotUI[plotId].pointSelect.value = "";
  }

  // clear this plot‚Äôs result panel (optional but recommended)
  document.getElementById(ctx.resultsId).innerHTML = "";
  document.getElementById(ctx.derivedId).innerHTML = "";
}

function attachClearButtons(){
  document.querySelectorAll(".clear-plot-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      clearPlot(btn.dataset.plot);
    });
  });
}




</script>

</body>
</html>
